<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Báo Cáo Phân Tích Dinh Dưỡng</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Recharts (UMD) -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <!-- Babel to compile JSX in the browser (simple for GitHub Pages) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useMemo } = React;
      const {
        LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
        BarChart, Bar, PieChart, Pie, Cell, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar
      } = Recharts;

      // Simple inline SVG icon components (thay cho lucide-react)
      const IconActivity = (props) => (
        <svg viewBox="0 0 24 24" className={"w-5 h-5 " + (props.className||"") } fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
      );
      const IconTarget = (props) => (
        <svg viewBox="0 0 24 24" className={"w-5 h-5 " + (props.className||"") } fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <circle cx="12" cy="12" r="6"/>
          <circle cx="12" cy="12" r="2"/>
        </svg>
      );
      const IconTrendingUp = (props) => (
        <svg viewBox="0 0 24 24" className={"w-5 h-5 " + (props.className||"") } fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
          <polyline points="17 6 23 6 23 12"/>
        </svg>
      );
      const IconTrendingDown = (props) => (
        <svg viewBox="0 0 24 24" className={"w-5 h-5 " + (props.className||"") } fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
          <polyline points="17 18 23 18 23 12"/>
        </svg>
      );

      function NutritionAnalysisReport() {
        // Raw data từ file gốc
        const rawData = [
          { date: '01/08/2025', fat: 634.32, carbs: 852.61, protein: 285.99 },
          { date: '02/08/2025', fat: 599.50, carbs: 779.30, protein: 291.47 },
          { date: '03/08/2025', fat: 816.15, carbs: 871.30, protein: 313.37 },
          { date: '04/08/2025', fat: 587.99, carbs: 836.22, protein: 297.95 },
          { date: '05/08/2025', fat: 734.96, carbs: 863.10, protein: 312.20 },
          { date: '06/08/2025', fat: 577.81, carbs: 929.66, protein: 277.18 },
          { date: '07/08/2025', fat: 712.59, carbs: 803.84, protein: 324.01 },
          { date: '08/08/2025', fat: 537.05, carbs: 871.66, protein: 268.84 },
          { date: '09/08/2025', fat: 627.42, carbs: 808.18, protein: 314.75 },
          { date: '10/08/2025', fat: 532.85, carbs: 834.82, protein: 276.86 },
          { date: '11/08/2025', fat: 569.34, carbs: 932.09, protein: 312.59 },
          { date: '12/08/2025', fat: 549.15, carbs: 781.09, protein: 324.49 },
          { date: '13/08/2025', fat: 676.27, carbs: 829.33, protein: 291.31 },
          { date: '14/08/2025', fat: 579.29, carbs: 811.64, protein: 285.87 },
          { date: '15/08/2025', fat: 654.42, carbs: 926.53, protein: 370.74 },
          { date: '16/08/2025', fat: 561.82, carbs: 849.29, protein: 273.69 },
          { date: '17/08/2025', fat: 515.03, carbs: 751.64, protein: 250.84 },
          { date: '18/08/2025', fat: 657.90, carbs: 876.74, protein: 367.38 },
          { date: '19/08/2025', fat: 676.71, carbs: 826.75, protein: 317.48 },
          { date: '20/08/2025', fat: 529.71, carbs: 889.76, protein: 344.10 },
          { date: '21/08/2025', fat: 698.54, carbs: 765.74, protein: 260.49 },
          { date: '22/08/2025', fat: 587.44, carbs: 915.38, protein: 315.26 },
          { date: '23/08/2025', fat: 631.61, carbs: 661.09, protein: 358.57 },
          { date: '24/08/2025', fat: 603.28, carbs: 793.10, protein: 358.59 },
          { date: '25/08/2025', fat: 568.30, carbs: 764.63, protein: 290.94 },
          { date: '26/08/2025', fat: 660.75, carbs: 896.72, protein: 319.98 },
          { date: '27/08/2025', fat: 558.44, carbs: 708.06, protein: 281.60 },
          { date: '28/08/2025', fat: 528.21, carbs: 871.28, protein: 363.08 },
          { date: '29/08/2025', fat: 598.74, carbs: 717.57, protein: 298.40 },
          { date: '30/08/2025', fat: 658.13, carbs: 788.13, protein: 310.18 },
          { date: '31/08/2025', fat: 526.77, carbs: 817.52, protein: 354.49 }
        ];

        const targets = {
          totalCalories: 1700,
          fatCalories: 585, // 65g × 9 kcal/g
          carbsCalories: 760, // 190g × 4 kcal/g
          proteinCalories: 300, // 75g × 4 kcal/g
          fatPercentage: 35,
          carbsPercentage: 45,
          proteinPercentage: 20
        };

        const processedData = useMemo(() => {
          return rawData.map((day, index) => {
            const totalCalories = day.fat + day.carbs + day.protein;
            const fatPercentage = (day.fat / totalCalories) * 100;
            const carbsPercentage = (day.carbs / totalCalories) * 100;
            const proteinPercentage = (day.protein / totalCalories) * 100;

            return {
              ...day,
              dayNumber: index + 1,
              totalCalories,
              fatPercentage,
              carbsPercentage,
              proteinPercentage,
              fatGrams: day.fat / 9,
              carbsGrams: day.carbs / 4,
              proteinGrams: day.protein / 4
            };
          });
        }, []);

        const stats = useMemo(() => {
          const totalDays = processedData.length;
          const sum = (arr, key) => arr.reduce((s, d) => s + d[key], 0);

          const avgTotalCalories = sum(processedData, 'totalCalories') / totalDays;
          const avgFatCalories = sum(processedData, 'fat') / totalDays;
          const avgCarbsCalories = sum(processedData, 'carbs') / totalDays;
          const avgProteinCalories = sum(processedData, 'protein') / totalDays;

          const avgFatPercentage = sum(processedData, 'fatPercentage') / totalDays;
          const avgCarbsPercentage = sum(processedData, 'carbsPercentage') / totalDays;
          const avgProteinPercentage = sum(processedData, 'proteinPercentage') / totalDays;

          return {
            avgTotalCalories,
            avgFatCalories,
            avgCarbsCalories,
            avgProteinCalories,
            avgFatPercentage,
            avgCarbsPercentage,
            avgProteinPercentage,
            avgFatGrams: avgFatCalories / 9,
            avgCarbsGrams: avgCarbsCalories / 4,
            avgProteinGrams: avgProteinCalories / 4
          };
        }, [processedData]);

        const extremes = useMemo(() => {
          const sorted = [...processedData].sort((a, b) => a.totalCalories - b.totalCalories);
          return {
            lowestCalorie: sorted[0],
            highestCalorie: sorted[sorted.length - 1],
            lowestFatDay: [...processedData].sort((a, b) => a.fatPercentage - b.fatPercentage)[0],
            highestFatDay: [...processedData].sort((a, b) => b.fatPercentage - a.fatPercentage)[0]
          };
        }, [processedData]);

        const chartData = processedData.map(day => ({
          day: day.dayNumber,
          date: day.date,
          'Tổng Calo': Math.round(day.totalCalories),
          'Chất béo': Math.round(day.fat),
          'Carbohydrate': Math.round(day.carbs),
          'Protein': Math.round(day.protein),
          'Mục tiêu': targets.totalCalories
        }));

        const pieData = [
          { name: 'Chất béo', value: Math.round(stats.avgFatPercentage), color: '#ff6b6b', target: targets.fatPercentage },
          { name: 'Carbohydrate', value: Math.round(stats.avgCarbsPercentage), color: '#4ecdc4', target: targets.carbsPercentage },
          { name: 'Protein', value: Math.round(stats.avgProteinPercentage), color: '#45b7d1', target: targets.proteinPercentage }
        ];

        const radarData = [
          { subject: 'Tổng Calo', actual: (stats.avgTotalCalories / targets.totalCalories) * 100, target: 100, fullMark: 120 },
          { subject: 'Chất béo', actual: (stats.avgFatCalories / targets.fatCalories) * 100, target: 100, fullMark: 120 },
          { subject: 'Carbohydrate', actual: (stats.avgCarbsCalories / targets.carbsCalories) * 100, target: 100, fullMark: 120 },
          { subject: 'Protein', actual: (stats.avgProteinCalories / targets.proteinCalories) * 100, target: 100, fullMark: 120 }
        ];

        const ComparisonCard = ({ title, actual, target, unit, Icon }) => {
          const percentage = (actual / target) * 100;
          const isOver = percentage > 110;
          const isUnder = percentage < 90;
          const status = isOver ? 'over' : isUnder ? 'under' : 'good';
          const statusColors = {
            over: 'text-red-600 bg-red-50 border-red-200',
            under: 'text-amber-600 bg-amber-50 border-amber-200',
            good: 'text-green-600 bg-green-50 border-green-200'
          };

          return (
            <div className={`p-4 rounded-lg border ${statusColors[status]}`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  {Icon ? <Icon /> : null}
                  <h3 className="font-semibold text-sm">{title}</h3>
                </div>
                <span className="text-xs font-medium">{percentage.toFixed(1)}%</span>
              </div>
              <div className="space-y-1">
                <div className="flex justify-between text-sm">
                  <span>Thực tế:</span>
                  <span className="font-medium">{actual.toFixed(1)} {unit}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span>Mục tiêu:</span>
                  <span>{target} {unit}</span>
                </div>
                <div className="flex justify-between text-sm font-medium">
                  <span>Chênh lệch:</span>
                  <span className={`${isOver ? 'text-red-600' : isUnder ? 'text-amber-600' : 'text-green-600'}`}>
                    {isOver ? '+' : ''}{(actual - target).toFixed(1)} {unit}
                  </span>
                </div>
              </div>
            </div>
          );
        };

        return (
          <div className="max-w-7xl mx-auto p-6 bg-gray-50 min-h-screen">
            <div className="bg-white rounded-lg shadow-lg p-8">
              <header className="mb-8">
                <h1 className="text-3xl font-bold text-gray-800 mb-2">Báo Cáo Phân Tích Dinh Dưỡng</h1>
                <p className="text-gray-600">Bệnh nhân nam 28 tuổi - Ăn qua sond dạ dày PEG - Tháng 8/2025</p>
              </header>

              {/* Tóm tắt */}
              <section className="mb-8">
                <h2 className="text-2xl font-semibold mb-4 text-gray-800">Tóm Tắt Tổng Quan</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <ComparisonCard title="Tổng Năng Lượng" actual={stats.avgTotalCalories} target={targets.totalCalories} unit="kcal" Icon={IconActivity} />
                  <ComparisonCard title="Chất Béo" actual={stats.avgFatGrams} target={65} unit="g" Icon={IconTarget} />
                  <ComparisonCard title="Carbohydrate" actual={stats.avgCarbsGrams} target={190} unit="g" Icon={IconTrendingUp} />
                  <ComparisonCard title="Protein" actual={stats.avgProteinGrams} target={75} unit="g" Icon={IconTrendingDown} />
                </div>
              </section>

              {/* Kết quả chính */}
              <section className="mb-8">
                <h2 className="text-2xl font-semibold mb-4 text-gray-800">Kết Quả Chính</h2>
                <div className="grid md:grid-cols-2 gap-6">
                  <div className="bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h3 className="text-lg font-semibold text-blue-800 mb-3">Điểm Tích Cực</h3>
                    <ul className="space-y-2 text-blue-700">
                      <li>• Lượng carbohydrate trung bình đạt {stats.avgCarbsPercentage.toFixed(1)}%, gần với mục tiêu 45%</li>
                      <li>• Protein đạt trung bình {stats.avgProteinGrams.toFixed(1)}g/ngày</li>
                      <li>• Chế độ ăn tương đối ổn định qua thời gian</li>
                    </ul>
                  </div>
                  <div className="bg-amber-50 p-6 rounded-lg border border-amber-200">
                    <h3 className="text-lg font-semibold text-amber-800 mb-3">Cần Cải Thiện</h3>
                    <ul className="space-y-2 text-amber-700">
                      <li>• Tổng calo trung bình {stats.avgTotalCalories.toFixed(0)} kcal, thấp hơn mục tiêu 1700 kcal</li>
                      <li>• Tỷ lệ chất béo {stats.avgFatPercentage.toFixed(1)}%, cao hơn mục tiêu 35%</li>
                      <li>• Biến động lớn giữa các ngày (từ {extremes.lowestCalorie.totalCalories.toFixed(0)} đến {extremes.highestCalorie.totalCalories.toFixed(0)} kcal)</li>
                    </ul>
                  </div>
                </div>
              </section>

              {/* Biểu đồ */}
              <section className="mb-8">
                <h2 className="text-2xl font-semibold mb-6 text-gray-800">Biểu Đồ Phân Tích</h2>

                {/* Xu hướng calo */}
                <div className="bg-white p-6 rounded-lg border border-gray-200 mb-6">
                  <h3 className="text-lg font-semibold mb-4">Xu Hướng Calo Hàng Ngày</h3>
                  <div style={{ width: '100%', height: 400 }}>
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="day" />
                        <YAxis />
                        <Tooltip formatter={(value, name) => [`${value} kcal`, name]} />
                        <Legend />
                        <Line type="monotone" dataKey="Tổng Calo" stroke="#2563eb" strokeWidth={2} dot={{ r: 4 }} />
                        <Line type="monotone" dataKey="Mục tiêu" stroke="#dc2626" strokeWidth={2} strokeDasharray="5 5" />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                {/* Phân bố trung bình / Radar */}
                <div className="grid md:grid-cols-2 gap-6 mb-6">
                  <div className="bg-white p-6 rounded-lg border border-gray-200">
                    <h3 className="text-lg font-semibold mb-4">Phân Bố Dinh Dưỡng Trung Bình</h3>
                    <div style={{ width: '100%', height: 300 }}>
                      <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                          <Pie data={pieData} cx="50%" cy="50%" outerRadius={100} fill="#8884d8" dataKey="value" label={({ name, value }) => `${name}: ${value}%`}>
                            {pieData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={entry.color} />
                            ))}
                          </Pie>
                          <Tooltip />
                        </PieChart>
                      </ResponsiveContainer>
                    </div>
                  </div>

                  <div className="bg-white p-6 rounded-lg border border-gray-200">
                    <h3 className="text-lg font-semibold mb-4">So Sánh Với Mục Tiêu</h3>
                    <div style={{ width: '100%', height: 300 }}>
                      <ResponsiveContainer width="100%" height="100%">
                        <RadarChart data={radarData}>
                          <PolarGrid />
                          <PolarAngleAxis dataKey="subject" />
                          <PolarRadiusAxis domain={[0, 120]} tickCount={4} />
                          <Radar name="Thực tế" dataKey="actual" stroke="#2563eb" fill="#2563eb" fillOpacity={0.3} />
                          <Radar name="Mục tiêu" dataKey="target" stroke="#dc2626" fill="#dc2626" fillOpacity={0.1} />
                          <Legend />
                        </RadarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>

                {/* Bar nhóm */}
                <div className="bg-white p-6 rounded-lg border border-gray-200">
                  <h3 className="text-lg font-semibold mb-4">Phân Tích Theo Nhóm Dinh Dưỡng</h3>
                  <div style={{ width: '100%', height: 400 }}>
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="day" />
                        <YAxis />
                        <Tooltip />
                        <Legend />
                        <Bar dataKey="Chất béo" fill="#ff6b6b" />
                        <Bar dataKey="Carbohydrate" fill="#4ecdc4" />
                        <Bar dataKey="Protein" fill="#45b7d1" />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </section>

              {/* Chi tiết */}
              <section className="mb-8">
                <h2 className="text-2xl font-semibold mb-4 text-gray-800">Phân Tích Chi Tiết</h2>
                <div className="grid lg:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <h3 className="text-lg font-semibold">Ngày Có Biến Động Lớn</h3>
                    <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                      <h4 className="font-medium text-red-800 mb-2">Ngày Calo Thấp Nhất</h4>
                      <p className="text-red-700">Ngày {extremes.lowestCalorie.dayNumber} ({extremes.lowestCalorie.date}): {extremes.lowestCalorie.totalCalories.toFixed(0)} kcal</p>
                      <p className="text-sm text-red-600 mt-1">Thấp hơn mục tiêu {(targets.totalCalories - extremes.lowestCalorie.totalCalories).toFixed(0)} kcal ({((extremes.lowestCalorie.totalCalories / targets.totalCalories - 1) * 100).toFixed(1)}%)</p>
                    </div>
                    <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                      <h4 className="font-medium text-green-800 mb-2">Ngày Calo Cao Nhất</h4>
                      <p className="text-green-700">Ngày {extremes.highestCalorie.dayNumber} ({extremes.highestCalorie.date}): {extremes.highestCalorie.totalCalories.toFixed(0)} kcal</p>
                      <p className="text-sm text-green-600 mt-1">Vượt mục tiêu {(extremes.highestCalorie.totalCalories - targets.totalCalories).toFixed(0)} kcal ({((extremes.highestCalorie.totalCalories / targets.totalCalories - 1) * 100).toFixed(1)}%)</p>
                    </div>
                  </div>

                  <div className="space-y-4">
                    <h3 className="text-lg font-semibold">Tỷ Lệ Dinh Dưỡng</h3>
                    <div className="space-y-3">
                      <div className="bg-gray-50 p-3 rounded-lg">
                        <div className="flex justify-between items-center mb-1">
                          <span className="text-sm font-medium">Chất béo</span>
                          <span className="text-sm">{stats.avgFatPercentage.toFixed(1)}% / 35%</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div className="bg-red-500 h-2 rounded-full" style={{ width: `${Math.min((stats.avgFatPercentage / 35) * 100, 100)}%` }}></div>
                        </div>
                      </div>
                      <div className="bg-gray-50 p-3 rounded-lg">
                        <div className="flex justify-between items-center mb-1">
                          <span className="text-sm font-medium">Carbohydrate</span>
                          <span className="text-sm">{stats.avgCarbsPercentage.toFixed(1)}% / 45%</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div className="bg-teal-500 h-2 rounded-full" style={{ width: `${Math.min((stats.avgCarbsPercentage / 45) * 100, 100)}%` }}></div>
                        </div>
                      </div>
                      <div className="bg-gray-50 p-3 rounded-lg">
                        <div className="flex justify-between items-center mb-1">
                          <span className="text-sm font-medium">Protein</span>
                          <span className="text-sm">{stats.avgProteinPercentage.toFixed(1)}% / 20%</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div className="bg-blue-500 h-2 rounded-full" style={{ width: `${Math.min((stats.avgProteinPercentage / 20) * 100, 100)}%` }}></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section className="mb-8">
                <h2 className="text-2xl font-semibold mb-4 text-gray-800">Khuyến Nghị Điều Chỉnh</h2>
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                  <h3 className="text-lg font-semibold text-blue-800 mb-4">Chiến Lược Cải Thiện</h3>
                  <div className="grid md:grid-cols-2 gap-6">
                    <div>
                      <h4 className="font-medium text-blue-700 mb-2">Tăng Calo Tổng:</h4>
                      <ul className="space-y-1 text-blue-600 text-sm">
                        <li>• Tăng khẩu phần sữa từ 230 kcal/bữa lên 280 kcal/bữa</li>
                        <li>• Thêm 1 bữa ăn nhẹ bổ sung (150-200 kcal)</li>
                        <li>• Tăng cường độ đậm đặc của súp xay</li>
                      </ul>
                    </div>
                    <div>
                      <h4 className="font-medium text-blue-700 mb-2">Cân Bằng Dinh Dưỡng:</h4>
                      <ul className="space-y-1 text-blue-600 text-sm">
                        <li>• Giảm tỷ lệ chất béo từ {stats.avgFatPercentage.toFixed(1)}% xuống 35%</li>
                        <li>• Tăng carbohydrate phức hợp</li>
                        <li>• Đảm bảo protein chất lượng cao</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </section>

              <footer className="text-center text-gray-500 text-sm pt-6 border-t border-gray-200">
                <p>Báo cáo được tạo tự động dựa trên dữ liệu dinh dưỡng tháng 8/2025</p>
                <p>Khuyến nghị cần được xem xét bởi chuyên gia dinh dưỡng</p>
              </footer>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<NutritionAnalysisReport />);
    </script>
  </body>
</html>
